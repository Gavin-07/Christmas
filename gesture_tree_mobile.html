<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Gesture Christmas Tree Â· Deluxe</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <style>
    :root {
      --tree-hue: 140;
      --tree-scale: 1.08;
      --tree-rotate: 0deg;
      --snow-speed: 18s;
      --glow-strength: 0.8;
      --accent-hue: 40;
      --bg-top: #171e3c;
      --bg-bottom: #050713;
      --garland-hue: 30;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 10% -10%, rgba(114, 188, 255, 0.35), transparent 55%),
        radial-gradient(circle at 90% 0%, rgba(255, 120, 210, 0.25), transparent 55%),
        radial-gradient(circle at 50% 120%, rgba(255, 219, 140, 0.28), transparent 65%),
        linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
      color: #f5f5f5;
      height: 100vh;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .app {
      position: relative;
      width: 100%;
      max-width: 1200px;
      height: 100%;
      padding: 14px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.2fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: minmax(0, 1.4fr) minmax(0, 1fr);
        padding: 10px;
      }
    }

    .scene {
      position: relative;
      border-radius: 26px;
      overflow: hidden;
      background:
        radial-gradient(circle at 20% 5%, rgba(167, 210, 255, 0.45), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(255, 186, 238, 0.4), transparent 55%),
        radial-gradient(circle at 50% 130%, rgba(255, 238, 180, 0.4), transparent 70%),
        radial-gradient(circle at 30% 90%, #283354 0%, #050814 55%);
      box-shadow:
        0 24px 70px rgba(0, 0, 0, 0.85),
        0 0 90px rgba(120, 210, 255, 0.35);
    }

    .scene-inner {
      position: relative;
      width: 100%;
      height: 100%;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* èƒŒæ™¯æ˜Ÿæ˜Ÿ */
    .stars-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      opacity: 0.85;
    }
    .star-dot {
      position: absolute;
      width: 2px;
      height: 2px;
      border-radius: 999px;
      background: radial-gradient(circle, #fff, transparent);
      opacity: 0.8;
      animation: starTwinkle 3.5s ease-in-out infinite alternate;
    }
    .star-dot:nth-child(3n) { animation-duration: 4.2s; }
    .star-dot:nth-child(5n) { animation-duration: 5s; opacity: 0.5; }

    @keyframes starTwinkle {
      0%   { transform: scale(0.7); opacity: 0.3; }
      100% { transform: scale(1.4); opacity: 0.95; }
    }

    .tree-wrap {
      position: relative;
      width: min(290px, 65vw);
      height: min(400px, 80vw);
      transform-origin: center bottom;
      transform:
        scale(var(--tree-scale))
        rotate(var(--tree-rotate));
      transition: transform 0.18s ease-out;
      filter:
        drop-shadow(0 26px 40px rgba(0, 0, 0, 0.9))
        drop-shadow(0 0 40px rgba(0, 0, 0, 0.7));
      touch-action: none;
    }

    /* èƒŒæ™¯å…‰æ™• */
    .tree-aura {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 10%, rgba(255, 255, 255, 0.6), transparent 60%),
        radial-gradient(circle at 50% 60%, rgba(0, 255, 190, 0.35), transparent 70%),
        radial-gradient(circle at 50% 80%, rgba(0, 204, 255, 0.35), transparent 80%);
      opacity: 0.8;
      filter: blur(20px);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    /* æ ‘å¹² */
    .trunk {
      position: absolute;
      bottom: 26px;
      left: 50%;
      width: 50px;
      height: 80px;
      transform: translateX(-50%);
      background:
        linear-gradient(160deg, #7b4a27, #3a220f);
      border-radius: 12px;
      box-shadow:
        inset 0 0 18px rgba(0, 0, 0, 0.7),
        0 0 12px rgba(0, 0, 0, 0.6);
    }
    .trunk::before {
      content: "";
      position: absolute;
      inset: 14% 20%;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 10%, rgba(255, 255, 255, 0.35), transparent 60%);
      opacity: 0.6;
    }

    /* æ ‘èŠ¯åœ†å¼§ï¼Œè®©æ ‘æ›´åœ†æ¶¦ */
    .tree-core {
      position: absolute;
      bottom: 40px;
      left: 50%;
      width: 210px;
      height: 260px;
      transform: translateX(-50%);
      border-radius: 50% 50% 40% 40%;
      background:
        radial-gradient(circle at 50% 10%, rgba(255, 255, 255, 0.25), transparent 65%),
        radial-gradient(circle at 50% 60%, hsla(var(--tree-hue), 80%, 32%, 1) 0%, hsla(var(--tree-hue), 65%, 18%, 1) 65%);
      filter:
        drop-shadow(0 0 24px hsla(var(--tree-hue), 90%, 40%, 0.7))
        drop-shadow(0 0 calc(55px * var(--glow-strength)) hsla(var(--tree-hue), 95%, 50%, 0.9));
    }

    /* å±‚å æ ‘å† ï¼ˆæ›´ç»†èŠ‚ï¼‰ */
    .tree-layer {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-style: solid;
    }

    .tree-layer.layer-1 {
      bottom: 190px;
      border-width: 0 70px 90px 70px;
      border-color: transparent transparent
        hsl(calc(var(--tree-hue) - 10), 80%, 32%) transparent;
      filter: drop-shadow(0 0 14px rgba(0, 0, 0, 0.8));
    }

    .tree-layer.layer-2 {
      bottom: 140px;
      border-width: 0 90px 110px 90px;
      border-color: transparent transparent
        hsl(var(--tree-hue), 78%, 30%) transparent;
      filter: drop-shadow(0 0 18px rgba(0, 0, 0, 0.9));
    }

    .tree-layer.layer-3 {
      bottom: 90px;
      border-width: 0 110px 120px 110px;
      border-color: transparent transparent
        hsl(calc(var(--tree-hue) + 5), 72%, 26%) transparent;
      filter: drop-shadow(0 0 24px rgba(0, 0, 0, 1));
    }

    .tree-layer.layer-4 {
      bottom: 46px;
      border-width: 0 126px 110px 126px;
      border-color: transparent transparent
        hsl(calc(var(--tree-hue) + 9), 70%, 22%) transparent;
      filter: drop-shadow(0 0 26px rgba(0, 0, 0, 1));
    }

    /* é¡¶éƒ¨æ˜Ÿæ˜Ÿ */
    .star {
      position: absolute;
      bottom: 235px;
      left: 50%;
      transform: translateX(-50%) rotate(10deg);
      width: 50px;
      height: 50px;
      background: conic-gradient(
        from 0deg,
        hsl(var(--accent-hue), 95%, 75%),
        #fffaf0,
        hsl(var(--accent-hue), 90%, 70%),
        #fff4c8,
        hsl(var(--accent-hue), 96%, 78%)
      );
      clip-path: polygon(
        50% 0%,
        64% 34%,
        100% 38%,
        72% 60%,
        80% 100%,
        50% 78%,
        20% 100%,
        28% 60%,
        0% 38%,
        36% 34%
      );
      box-shadow:
        0 0 16px rgba(255, 255, 255, 0.9),
        0 0 55px hsl(var(--accent-hue), 100%, 72%);
      animation: starPulse 2.4s ease-in-out infinite;
    }

    @keyframes starPulse {
      0%, 100% {
        transform: translateX(-50%) rotate(10deg) scale(1);
      }
      50% {
        transform: translateX(-50%) rotate(10deg) scale(1.16);
      }
    }

    /* ä¸å¸¦èŠ±ç¯ */
    .garlands {
      position: absolute;
      inset: 50px 0 80px;
      pointer-events: none;
    }

    .garland-line {
      position: absolute;
      left: 50%;
      width: 220px;
      height: 70px;
      border-radius: 999px;
      border-bottom: 3px dashed hsla(var(--garland-hue), 90%, 60%, 0.95);
      border-top: none;
      transform: translateX(-50%);
      filter:
        drop-shadow(0 0 10px hsla(var(--garland-hue), 100%, 65%, 0.9));
      opacity: 0.9;
    }
    .garland-line:nth-child(1) { top: 75px; width: 190px; }
    .garland-line:nth-child(2) { top: 115px; width: 230px; }
    .garland-line:nth-child(3) { top: 155px; width: 260px; }

    /* ç¯å…‰ & å½©çƒ */
    .lights, .ornaments {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .light-dot {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(
        circle,
        hsl(var(--accent-hue), 95%, 78%),
        hsla(var(--accent-hue), 90%, 45%, 0.1)
      );
      box-shadow:
        0 0 16px hsl(var(--accent-hue), 96%, 70%),
        0 0 32px hsl(var(--accent-hue), 98%, 68%);
      animation: blink 1.6s ease-in-out infinite alternate;
    }

    .light-dot:nth-child(odd) { animation-duration: 2.2s; }
    .light-dot:nth-child(3n)  { animation-duration: 1.5s; }
    .light-dot:nth-child(4n)  { animation-duration: 1.1s; }

    @keyframes blink {
      0%   { opacity: 0.35; transform: scale(0.75); }
      100% { opacity: 1;    transform: scale(1.2); }
    }

    .ornament {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff, transparent 60%),
                  radial-gradient(circle at 30% 80%, rgba(0,0,0,0.6), transparent 70%);
      box-shadow:
        0 0 10px rgba(0, 0, 0, 0.7),
        0 0 14px rgba(255, 255, 255, 0.5);
      transform-origin: center -8px;
      animation: ornamentSwing 2.8s ease-in-out infinite alternate;
    }
    @keyframes ornamentSwing {
      0%   { transform: rotate(-4deg); }
      100% { transform: rotate(4deg); }
    }

    /* é›ªèŠ± & åœ°é¢ */
    .snow-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .snowflake {
      position: absolute;
      top: -10%;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle, #fff, rgba(255, 255, 255, 0));
      opacity: 0.85;
      animation-name: snowfall;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      animation-duration: var(--snow-speed);
    }

    @keyframes snowfall {
      0%   { transform: translateY(-10vh); }
      100% { transform: translateY(110vh); }
    }

    .ground {
      position: absolute;
      inset: auto -10% 0 -10%;
      height: 100px;
      background:
        radial-gradient(circle at 50% 0%, #fbfeff 0%, #e1ebff 26%, #a9b5dd 60%, #4a517a 100%);
      filter: blur(2px);
    }

    .ground-reflection {
      position: absolute;
      inset: auto 20% 22px 20%;
      height: 60px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 0%, rgba(255,255,255,0.7), transparent 70%);
      opacity: 0.7;
      filter: blur(6px);
    }

    /* å³ä¾§é¢æ¿ */
    .sidebar {
      position: relative;
      border-radius: 26px;
      padding: 16px 16px 12px;
      background:
        radial-gradient(circle at 0% 0%, rgba(144, 198, 255, 0.3), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(255, 186, 210, 0.28), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(255, 228, 176, 0.28), transparent 70%),
        radial-gradient(circle at 40% 120%, #20263d 0%, #070b15 70%);
      box-shadow: 0 22px 60px rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(24px);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 184, 255, 0.12);
      border: 1px solid rgba(120, 220, 255, 0.5);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: radial-gradient(circle, #2bff88, #0bab5c);
      box-shadow: 0 0 8px #34ff96;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #fef6e7;
    }

    .subtitle {
      font-size: 13px;
      color: rgba(240, 240, 255, 0.7);
      line-height: 1.6;
    }

    .gestures {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .gesture-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(5, 10, 25, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .gesture-emoji {
      font-size: 18px;
      line-height: 1;
      margin-top: 2px;
    }

    .gesture-text-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .gesture-text-sub {
      font-size: 12px;
      color: rgba(230, 235, 255, 0.7);
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(4, 10, 20, 0.96);
      border: 1px solid rgba(120, 220, 255, 0.35);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .status-line {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .status-label {
      color: rgba(220, 230, 255, 0.8);
    }

    .status-value {
      font-family: "SF Mono", ui-monospace, Menlo, monospace;
      color: #fef8d8;
    }

    .footer {
      font-size: 11px;
      color: rgba(210, 220, 255, 0.5);
      margin-top: 8px;
      line-height: 1.6;
    }

    .footer b {
      color: rgba(255, 245, 210, 0.9);
    }

    /* æ‘„åƒå¤´å¯åŠ¨æŒ‰é’® */
    .start-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .start-btn {
      pointer-events: auto;
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #27e4ff, #ffce4e);
      color: #050815;
      box-shadow:
        0 0 12px rgba(39, 228, 255, 0.6),
        0 0 18px rgba(255, 206, 78, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .start-btn span {
      font-size: 16px;
    }

    @media (max-width: 900px) {
      .start-btn {
        padding: 9px 18px;
        font-size: 13px;
      }
    }

    #input_video {
      display: none;
    }

    /* éŸ³ä¹æŒ‰é’® */
    .music-toggle {
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(4, 10, 22, 0.92);
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }

    .music-toggle span.icon {
      font-size: 14px;
    }

    .music-toggle span.label {
      opacity: 0.85;
    }

    .music-toggle.on {
      border-color: rgba(255, 215, 130, 0.85);
      box-shadow: 0 0 16px rgba(255, 215, 130, 0.55);
      background: radial-gradient(circle at 0 0, rgba(255, 241, 191, 0.5), rgba(4, 10, 22, 0.95));
    }

  </style>
</head>
<body>
  <div class="app">
    <div class="scene">
      <div class="scene-inner">
        <div class="stars-layer" id="starsLayer"></div>

        <div class="tree-wrap" id="treeWrap">
          <div class="tree-aura"></div>

          <div class="star"></div>

          <div class="tree-core"></div>

          <div class="tree-layer layer-1"></div>
          <div class="tree-layer layer-2"></div>
          <div class="tree-layer layer-3"></div>
          <div class="tree-layer layer-4"></div>

          <div class="garlands">
            <div class="garland-line"></div>
            <div class="garland-line"></div>
            <div class="garland-line"></div>
          </div>

          <div class="trunk"></div>

          <div class="lights" id="lights"></div>
          <div class="ornaments" id="ornaments"></div>
        </div>

        <div class="snow-layer" id="snowLayer"></div>
        <div class="ground"></div>
        <div class="ground-reflection"></div>

        <div class="start-overlay">
          <button id="startBtn" class="start-btn">
            <span>âœ¨</span> ç‚¹å‡»å¼€å§‹ä½“éªŒ
          </button>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div>
        <div class="badge">
          <span class="badge-dot"></span>
          <span>Gesture Xmas Â· Deluxe</span>
        </div>
        <h1 class="title">æ‰‹åŠ¿åœ£è¯æ ‘ Â· åä¸½ç‰ˆ</h1>
        <p class="subtitle">
          åœ¨æ‰‹æœºæˆ–ç”µè„‘æµè§ˆå™¨ä¸­æ‰“å¼€è¿™ä¸ªé¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§æŒ‰é’®æˆæƒæ‘„åƒå¤´ã€‚
          å¯¹ç€å±å¹•ä¸¾èµ·ä½ çš„æ‰‹ï¼Œè½»è½»ç§»åŠ¨ï¼Œå°±èƒ½å’Œè¿™æ£µåœ£è¯æ ‘äº’åŠ¨ã€‚
        </p>

        <div class="gestures">
          <div class="gesture-item">
            <div class="gesture-emoji">ğŸ¤²</div>
            <div>
              <div class="gesture-text-title">å·¦å³ç§»åŠ¨æ‰‹æŒ</div>
              <div class="gesture-text-sub">ä»å·¦åˆ°å³æ…¢æ…¢ç§»åŠ¨æ‰‹æŒï¼Œåœ£è¯æ ‘ä¼šè·Ÿç€æ—‹è½¬ï¼Œåƒå›´ç€å®ƒç»•åœˆçœ‹ç¤¼ç‰©ã€‚</div>
            </div>
          </div>
          <div class="gesture-item">
            <div class="gesture-emoji">âœ‹</div>
            <div>
              <div class="gesture-text-title">ä¸Šä¸‹ç§»åŠ¨æ‰‹æŒ</div>
              <div class="gesture-text-sub">å¾€ä¸ŠæŠ¬æ‰‹ï¼Œæ ‘ä¼šé è¿‘ä½ ï¼›å¾€ä¸‹ç§»ï¼Œæ ‘ä¼šç¼©å°é€€è¿œï¼Œåƒå˜ç„¦é•œå¤´ã€‚</div>
            </div>
          </div>
          <div class="gesture-item">
            <div class="gesture-emoji">ğŸ¤</div>
            <div>
              <div class="gesture-text-title">æ‹‡æŒ‡ + é£ŸæŒ‡æåˆ</div>
              <div class="gesture-text-sub">åˆ‡æ¢ä¸åŒä¸»é¢˜ï¼šæ£®ç³»ç»¿é‡‘ã€å†°è“åŒ—å¢ƒã€ç²‰ç´«æ´¾å¯¹ã€æš–æ©™å£ç‚‰ã€éœ“è™¹å½©è‰²ç¯ã€‚</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="status" id="statusBox">
          <div class="status-line">
            <span class="status-label">æ‘„åƒå¤´</span>
            <span class="status-value" id="camStatus">ç­‰å¾…ç‚¹å‡»â€œå¼€å§‹ä½“éªŒâ€</span>
          </div>
          <div class="status-line">
            <span class="status-label">æ£€æµ‹åˆ°çš„æ‰‹</span>
            <span class="status-value" id="handStatus">0</span>
          </div>
          <div class="status-line">
            <span class="status-label">å½“å‰ä¸»é¢˜</span>
            <span class="status-value" id="themeStatus">Forest Gold</span>
          </div>
        </div>

        <div id="musicToggle" class="music-toggle">
          <span class="icon">â™ª</span>
          <span class="label">éŸ³ä¹ï¼šå…³é—­</span>
        </div>

        <div class="footer">
          Â· BGM é»˜è®¤æ˜¯é™éŸ³çš„ï¼Œä½ å¯ä»¥ç‚¹å‡»ã€ŒéŸ³ä¹ã€å¼€å…³ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åœ¨ä»£ç é‡Œæ¢æˆä½ å–œæ¬¢çš„åœ£è¯æ­Œã€‚<br />
          Â· ä½ å¯ä»¥æŠŠè¿™é¡µå½“åšä¸“å±ç¥ç¦é¡µï¼Œæ”¹æ–‡æ¡ˆã€åŠ  logoï¼ŒæŠŠé“¾æ¥å‘ç»™æœ‹å‹ / å¯¹è±¡ / å®¢æˆ·ã€‚
        </div>
      </div>
    </aside>
  </div>

  <!-- èƒŒæ™¯éŸ³ä¹ -->
  <audio id="bgm" loop>
    <!-- æŠŠä¸‹é¢è¿™è¡Œ src æ¢æˆä½ è‡ªå·±çš„ mp3 é“¾æ¥æˆ–æ–‡ä»¶è·¯å¾„ -->
    <!-- <source src="https://ä½ çš„åœ£è¯bgmé“¾æ¥.mp3" type="audio/mpeg" /> -->
  </audio>

  <video id="input_video" playsinline></video>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <script>
    function clamp(v, min, max) {
      return Math.min(max, Math.max(min, v));
    }

    // æ˜Ÿæ˜Ÿ + é›ª + ç¯ + å½©çƒåˆå§‹åŒ–
    (function setupDecorations() {
      // æ˜Ÿæ˜Ÿ
      const starsLayer = document.getElementById('starsLayer');
      for (let i = 0; i < 80; i++) {
        const star = document.createElement('div');
        star.className = 'star-dot';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 60 + '%';
        star.style.animationDelay = (Math.random() * -4) + 's';
        starsLayer.appendChild(star);
      }

      // é›ª
      const snowLayer = document.getElementById('snowLayer');
      const snowCount = 90;
      for (let i = 0; i < snowCount; i++) {
        const s = document.createElement('div');
        s.className = 'snowflake';
        s.style.left = Math.random() * 100 + '%';
        s.style.animationDelay = (Math.random() * -22) + 's';
        s.style.animationDuration = (16 + Math.random() * 14) + 's';
        s.style.opacity = String(0.35 + Math.random() * 0.65);
        snowLayer.appendChild(s);
      }

      // å½©ç¯
      const lights = document.getElementById('lights');
      const lightPositions = [
        // top
        { x: 50, y: 135 }, { x: 42, y: 150 }, { x: 58, y: 152 },
        // second
        { x: 38, y: 185 }, { x: 50, y: 195 }, { x: 63, y: 188 },
        // third
        { x: 33, y: 225 }, { x: 46, y: 235 }, { x: 60, y: 238 }, { x: 70, y: 228 },
        // bottom
        { x: 30, y: 270 }, { x: 44, y: 278 }, { x: 58, y: 280 }, { x: 72, y: 270 }
      ];
      lightPositions.forEach(p => {
        const dot = document.createElement('div');
        dot.className = 'light-dot';
        dot.style.left = p.x + '%';
        dot.style.top = p.y + 'px';
        lights.appendChild(dot);
      });

      // å½©çƒ
      const ornaments = document.getElementById('ornaments');
      const ornamentData = [
        { x: 38, y: 165, color: '320, 90%, 70%' },
        { x: 62, y: 172, color: '200, 90%, 70%' },
        { x: 42, y: 210, color: '45, 95%, 68%' },
        { x: 59, y: 222, color: '120, 70%, 65%' },
        { x: 35, y: 248, color: '280, 85%, 72%' },
        { x: 69, y: 252, color: '10, 90%, 68%' },
        { x: 48, y: 265, color: '50, 96%, 70%' }
      ];
      ornamentData.forEach((p, idx) => {
        const o = document.createElement('div');
        o.className = 'ornament';
        o.style.left = p.x + '%';
        o.style.top = p.y + 'px';
        o.style.background =
          'radial-gradient(circle at 28% 18%, #fff, transparent 55%),' +
          `radial-gradient(circle at 70% 80%, hsla(${p.color}, 0.9), transparent 70%)`;
        o.style.animationDelay = (idx * 0.3) + 's';
        ornaments.appendChild(o);
      });
    })();

    // ä¸»é¢˜
    const themeStatusEl = document.getElementById('themeStatus');
    const handStatusEl  = document.getElementById('handStatus');
    const camStatusEl   = document.getElementById('camStatus');

    const themes = [
      {
        label: 'Forest Gold',
        treeHue: 140,
        accentHue: 40,
        snowSpeed: 18,
        glow: 0.9,
        garlandHue: 30,
        bgTop: '#171f34',
        bgBottom: '#040611'
      },
      {
        label: 'Ice North',
        treeHue: 175,
        accentHue: 190,
        snowSpeed: 14,
        glow: 1.1,
        garlandHue: 190,
        bgTop: '#0c1c32',
        bgBottom: '#02040b'
      },
      {
        label: 'Party Magenta',
        treeHue: 310,
        accentHue: 320,
        snowSpeed: 20,
        glow: 1.05,
        garlandHue: 320,
        bgTop: '#261334',
        bgBottom: '#070313'
      },
      {
        label: 'Warm Fireplace',
        treeHue: 130,
        accentHue: 28,
        snowSpeed: 19,
        glow: 0.95,
        garlandHue: 25,
        bgTop: '#2b1a16',
        bgBottom: '#09030a'
      },
      {
        label: 'Neon Rainbow',
        treeHue: 150,
        accentHue: 60,
        snowSpeed: 17,
        glow: 1.15,
        garlandHue: 280,
        bgTop: '#120c29',
        bgBottom: '#05020b'
      }
    ];

    let themeIndex = 0;

    function applyTheme(index) {
      const t = themes[index];
      document.documentElement.style.setProperty('--tree-hue',   t.treeHue);
      document.documentElement.style.setProperty('--accent-hue', t.accentHue);
      document.documentElement.style.setProperty('--snow-speed', t.snowSpeed + 's');
      document.documentElement.style.setProperty('--glow-strength', t.glow);
      document.documentElement.style.setProperty('--garland-hue', t.garlandHue);
      document.documentElement.style.setProperty('--bg-top', t.bgTop);
      document.documentElement.style.setProperty('--bg-bottom', t.bgBottom);
      themeStatusEl.textContent = t.label;
    }
    applyTheme(themeIndex);

    let lastPinchTime = 0;

    function handleHandLandmarks(landmarks) {
      if (!landmarks || !landmarks.length) {
        handStatusEl.textContent = '0';
        return;
      }
      handStatusEl.textContent = String(landmarks.length);

      const hand = landmarks[0];
      const center = hand[9];
      const x = center.x;
      const y = center.y;

      const rot   = (x - 0.5) * 60;
      const scale = 0.9 + (0.5 - y) * 0.9;
      document.documentElement.style.setProperty('--tree-rotate', clamp(rot, -32, 32) + 'deg');
      document.documentElement.style.setProperty('--tree-scale', String(clamp(scale, 0.8, 1.5)));

      const thumbTip = hand[4];
      const indexTip = hand[8];
      const dx = thumbTip.x - indexTip.x;
      const dy = thumbTip.y - indexTip.y;
      const dist = Math.sqrt(dx * dx + dy * dy);

      const now = performance.now();
      const isPinched = dist < 0.055;
      if (isPinched && now - lastPinchTime > 650) {
        lastPinchTime = now;
        themeIndex = (themeIndex + 1) % themes.length;
        applyTheme(themeIndex);
      }
    }

    // pointer æ‹–æ‹½ï¼ˆæ²¡å¼€æ‘„åƒå¤´ä¹Ÿèƒ½ç©ï¼‰
    (function setupPointerControl() {
      const tree = document.getElementById('treeWrap');
      let dragging = false;
      let startX = 0, startY = 0;
      let baseRotate = 0, baseScale = 1;

      function getVars() {
        const cs = getComputedStyle(document.documentElement);
        const rotStr   = cs.getPropertyValue('--tree-rotate').trim();
        const scaleStr = cs.getPropertyValue('--tree-scale').trim();
        return {
          rotate: parseFloat(rotStr.replace('deg', '')) || 0,
          scale:  parseFloat(scaleStr) || 1
        };
      }

      tree.addEventListener('pointerdown', (e) => {
        dragging = true;
        tree.setPointerCapture(e.pointerId);
        startX = e.clientX;
        startY = e.clientY;
        const v = getVars();
        baseRotate = v.rotate;
        baseScale  = v.scale;
      });

      tree.addEventListener('pointermove', (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        const newRot   = baseRotate + dx * 0.25;
        const newScale = baseScale  - dy * 0.006;
        document.documentElement.style.setProperty('--tree-rotate', clamp(newRot, -45, 45) + 'deg');
        document.documentElement.style.setProperty('--tree-scale',  String(clamp(newScale, 0.7, 1.7)));
      });

      function end(e) {
        dragging = false;
        try { tree.releasePointerCapture(e.pointerId); } catch (_) {}
      }
      tree.addEventListener('pointerup', end);
      tree.addEventListener('pointercancel', end);
    })();

    // Mediapipe Hands
    const videoElement = document.getElementById('input_video');

    const hands = new Hands({
      locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults((results) => {
      const landmarks = results.multiHandLandmarks || [];
      handleHandLandmarks(landmarks);
    });

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({ image: videoElement });
      },
      width: 640,
      height: 480
    });

    const startBtn     = document.getElementById('startBtn');
    const bgmAudio     = document.getElementById('bgm');
    const musicToggle  = document.getElementById('musicToggle');
    const musicLabel   = musicToggle.querySelector('.label');
    let cameraStarted  = false;
    let musicOn        = false;

    function updateMusicUI() {
      if (musicOn && !bgmAudio.muted) {
        musicToggle.classList.add('on');
        musicLabel.textContent = 'éŸ³ä¹ï¼šå¼€å¯';
      } else {
        musicToggle.classList.remove('on');
        musicLabel.textContent = 'éŸ³ä¹ï¼šå…³é—­';
      }
    }

    async function safePlayMusic() {
      if (!bgmAudio || !bgmAudio.src) return;
      try {
        await bgmAudio.play();
        musicOn = true;
        bgmAudio.muted = false;
      } catch (e) {
        // æœ‰äº›æµè§ˆå™¨å¯èƒ½ä¾æ—§æ‹¦æˆªï¼Œè¿™é‡Œå°±é™é»˜å¤±è´¥
      }
      updateMusicUI();
    }

    // å¯åŠ¨æŒ‰é’®ï¼šå¼€æ‘„åƒå¤´ + å°è¯•æ’­ BGM
    startBtn.addEventListener('click', async () => {
      if (!cameraStarted) {
        cameraStarted = true;
        startBtn.style.display = 'none';
        try {
          await camera.start();
          camStatusEl.textContent = 'å·²å¯åŠ¨ âœ“';
        } catch (e) {
          console.error(e);
          camStatusEl.textContent = 'æ‘„åƒå¤´å¤±è´¥ï¼ˆæ£€æŸ¥æƒé™ / HTTPS / æµè§ˆå™¨è®¾ç½®ï¼‰';
        }
      }
      await safePlayMusic();
    });

    // éŸ³ä¹å¼€å…³
    musicToggle.addEventListener('click', async () => {
      if (!bgmAudio.src) {
        alert('è¯·å…ˆåœ¨ä»£ç ä¸­ä¸º <audio id="bgm"> è®¾ç½®ä¸€ä¸ª mp3 çš„ src é“¾æ¥ï¼Œå†ä½¿ç”¨éŸ³ä¹åŠŸèƒ½ã€‚');
        return;
      }
      if (!musicOn) {
        await safePlayMusic();
      } else {
        bgmAudio.muted = !bgmAudio.muted;
        if (bgmAudio.muted) musicOn = false;
        updateMusicUI();
      }
    });

  </script>
</body>
</html>
